#!/bin/sh
set -e

if [ ! "$1" ]; then
  echo "Usage: jlfs <name>"
  exit 1
fi

name=$1

if [ -d "/jails/${name}" ]; then
  exit 0
fi

jroot=`zfs mount | grep '[[:space:]]/jails$' | awk '{print $1}'`
zfs create ${jroot}/${name}
zfs create ${jroot}/${name}/tmp
zfs create -o canmount=off ${jroot}/${name}/usr
zfs create ${jroot}/${name}/usr/home
zfs create -o canmount=off ${jroot}/${name}/var
zfs create ${jroot}/${name}/var/log

myroot=`zfs mount | grep '[[:space:]]/$' | awk '{print $1}'`
mymountpoint=`zfs get -H -o value mountpoint $myroot`
# can't set jailed=on if we're in a jail already
if [ $mymountpoint = "/" ]; then
    jailed_args="-o jailed=on"
fi
zfs create $jailed_args -o mountpoint=none ${jroot}/${name}/zdata

if [ ! -f ~/dist/base.txz ]; then
  mkdir -p ~/dist
  fetch -o ~/dist/base.txz https://download.freebsd.org/releases/amd64/13.1-RELEASE/base.txz
fi

tar -C /jails/${name} -xf ~/dist/base.txz
cat > /jails/${name}/etc/resolv.conf << EOF
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF
